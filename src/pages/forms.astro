---
import Input from "../components/Input.astro";
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout>
  <div class="container">
    <ul class="mpp-user-data-forms">
      <li class="mpp-user-data-item">
        <input
          hidden
          class="mpp-user-data-item__checkbox"
          checked=""
          type="checkbox"
          id="change-password"
        />
        <label class="mpp-user-data__head" for="change-password"
          >Сменить пароль</label
        >
        <div class="mpp-user-data-wrap">
          <form
            id="yw1"
            class="mpp-user-data-form"
            action="/profile/password"
            method="post"
            enctype="multipart/form-data"
          >
            <Input
              id="ProfilePasswordForm_password"
              name="ProfilePasswordForm[password]"
              type="password"
              title="Пароль"
            />
            <Input
              id="ProfilePasswordForm_cPassword"
              name="ProfilePasswordForm[cPassword]"
              type="password"
              title="Подтвердите пароль"
            />
            <div class="mpp-user-data-form-group-buttons">
              <button data-type="submit" type="submit">Сохранить</button>
              <button data-type="close">Отменить</button>
            </div>
            <p
              class="message message--pending"
            >
              Сохраняем ...
            </p>
            <p
              class="message message--success"
            >
              Сохранение прошло успешно
            </p>
            <p
              class="message message--error"
            >
              Произошла ошибка. Попробуйте снова.
            </p>
          </form>
        </div>
      </li>
      <li class="mpp-user-data-item">
        <input
          hidden
          class="mpp-user-data-item__checkbox"
          checked=""
          type="checkbox"
          id="change-contacts"
        />
        <label class="mpp-user-data__head" for="change-contacts"
          >Редактировать данные</label
        >
        <div class="mpp-user-data-wrap">
          <form
            enctype="multipart/form-data"
            class="mpp-user-data-form"
            data-inputs="3"
            action="/profile"
            method="post"
            id="yw0"
          >
            <Input
              id="ProfileForm_first_name"
              name="ProfileForm[first_name]"
              type="text"
              title="Имя"
            />
            <Input
              id="ProfileForm_last_name"
              name="ProfileForm[last_name]"
              type="text"
              title="Фамилия"
            />
            <Input
              id="ProfileForm_phone"
              name="ProfileForm[phone]"
              type="text"
              title="Телефон"
              dataType="phone"
              pattern={""}
            />
          </form>
        </div>
      </li>
    </ul>
    <form id="yw2" class="mpp-form-sertificate" action="/profile/activatePromocode" method="post">
        <div class="mpp-form-sertificate-balance">
            <h3>Бонусный баланс</h3>
            <span>0.00 ₽</span>
        </div>
        <p class="mpp-form-sertificate__hint">Начисленные баллы используйте при оформлении заказа. 1&nbsp;балл&nbsp;=&nbsp;1&nbsp;рубль</p>
        <div class="mpp-form-sertificate-balance">
            <h3>Баланс сертификата</h3>
            <span>0.00 ₽</span>
        </div>
        <div class="mpp-form-sertificate-code">
            <Input
                id="code"
                name="code"
                type="text"
                title="Код"
            />
            <div class="mpp-user-data-form-group-buttons">
                <button data-type="submit" type="submit">Активировать</button>
            </div> 
        </div>

        
    </form>
  </div>
</BaseLayout>

<script>
  document.querySelectorAll(`.mpp-user-data-form-group input`).forEach((el) => {
    el.addEventListener("input", () => {
        if(el.value) {
            el.closest(".mpp-user-data-form-group").classList.add("mpp-user-data-form-group--has-value");
        }
        else {
            el.closest(".mpp-user-data-form-group").classList.remove("mpp-user-data-form-group--has-value");
        }

    });
  });

  document.querySelectorAll("form.mpp-user-data-form, .mpp-form-sertificate").forEach((el) => {
    el.addEventListener("submit", (form) => {
      form.preventDefault();
      let formData = new FormData(form.target);
      //   console.log("pending");
      fetch(form.target.action, {
        method: form.method,
        body: formData,
      })
        .then((response) => {
          if (response.ok) {
            console.log("success");
          }
        })
        .catch((error) => {
          console.log("error");
        })
        .finally(() => {
          for (var pair of formData.entries()) {
            console.log(pair[1]);
          }
        });
    });
  });
</script>

<script>
    const mask = (selector) => {
    function setMask() {
        let matrix = '+###############';


        const maskList = [
            { "code": "+247 ####" },
            { "code": "+290 ####" },
            { "code": "+290 ####" },
            { "code": "+683 ####" },
            { "code": "+690 ####" },
            { "code": "+500 #####" },
            { "code": "+676 #####" },
            { "code": "+677 #####" },
            { "code": "+678 #####" },
            { "code": "+688 2####" },
            { "code": "+49 ### ###" },
            { "code": "+682 ## ###" },
            { "code": "+686 ## ###" },
            { "code": "+688 90####" },
            { "code": "+95 ### ###" },
            { "code": "+298 ### ###" },
            { "code": "+376 ### ###" },
            { "code": "+387 ## ####" },
            { "code": "+508 ## ####" },
            { "code": "+597 ### ###" },
            { "code": "+672 1## ###" },
            { "code": "+672 3## ###" },
            { "code": "+681 ## ####" },
            { "code": "+685 ## ####" },
            { "code": "+687 ## ####" },
            { "code": "+850 ### ###" },
            { "code": "+230 ### ####" },
            { "code": "+239 ## #####" },
            { "code": "+245 # ######" },
            { "code": "+246 ### ####" },
            { "code": "+263 # ######" },
            { "code": "+269 ## #####" },
            { "code": "+297 ### ####" },
            { "code": "+299 ## ## ##" },
            { "code": "+354 ### ####" },
            { "code": "+372 ### ####" },
            { "code": "+387 ## #####" },
            { "code": "+49 ### ## ##" },
            { "code": "+501 ### ####" },
            { "code": "+507 ### ####" },
            { "code": "+592 ### ####" },
            { "code": "+597 ### ####" },
            { "code": "+599 ### ####" },
            { "code": "+599 ### ####" },
            { "code": "+599 ### ####" },
            { "code": "+60 # ### ###" },
            { "code": "+62 ## ### ##" },
            { "code": "+65 #### ####" },
            { "code": "+670 ### ####" },
            { "code": "+673 ### ####" },
            { "code": "+674 ### ####" },
            { "code": "+677 ### ####" },
            { "code": "+678 ## #####" },
            { "code": "+679 ## #####" },
            { "code": "+680 ### ####" },
            { "code": "+689 ## ## ##" },
            { "code": "+691 ### ####" },
            { "code": "+692 ### ####" },
            { "code": "+95 # ### ###" },
            { "code": "+960 ### ####" },
            { "code": "+220 ### ## ##" },
            { "code": "+232 ## ######" },
            { "code": "+234 ## ### ##" },
            { "code": "+237 #### ####" },
            { "code": "+238 ### ## ##" },
            { "code": "+248 # ### ###" },
            { "code": "+252 # ### ###" },
            { "code": "+252 # ### ###" },
            { "code": "+265 1 ### ###" },
            { "code": "+291 # ### ###" },
            { "code": "+350 ### #####" },
            { "code": "+356 #### ####" },
            { "code": "+372 #### ####" },
            { "code": "+373 #### ####" },
            { "code": "+47 ### ## ###" },
            { "code": "+49 ### ## ###" },
            { "code": "+504 #### ####" },
            { "code": "+505 #### ####" },
            { "code": "+506 #### ####" },
            { "code": "+52 ## ## ####" },
            { "code": "+53 # ### ####" },
            { "code": "+599 9### ####" },
            { "code": "+60 ## ### ###" },
            { "code": "+62 ## ### ###" },
            { "code": "+64 ## ### ###" },
            { "code": "+66 ## ### ###" },
            { "code": "+670 77# #####" },
            { "code": "+670 78# #####" },
            { "code": "+850 #### ####" },
            { "code": "+852 #### ####" },
            { "code": "+853 #### ####" },
            { "code": "+886 #### ####" },
            { "code": "+95 ## ### ###" },
            { "code": "+961 # ### ###" },
            { "code": "+965 #### ####" },
            { "code": "+967 # ### ###" },
            { "code": "+973 #### ####" },
            { "code": "+974 #### ####" },
            { "code": "+975 # ### ###" },
            { "code": "+1 ### ### ####" },
            { "code": "+1 242 ### ####" },
            { "code": "+1 246 ### ####" },
            { "code": "+1 264 ### ####" },
            { "code": "+1 268 ### ####" },
            { "code": "+1 284 ### ####" },
            { "code": "+1 340 ### ####" },
            { "code": "+1 345 ### ####" },
            { "code": "+1 441 ### ####" },
            { "code": "+1 473 ### ####" },
            { "code": "+1 649 ### ####" },
            { "code": "+1 664 ### ####" },
            { "code": "+1 670 ### ####" },
            { "code": "+1 671 ### ####" },
            { "code": "+1 684 ### ####" },
            { "code": "+1 721 ### ####" },
            { "code": "+1 758 ### ####" },
            { "code": "+1 767 ### ####" },
            { "code": "+1 784 ### ####" },
            { "code": "+1 809 ### ####" },
            { "code": "+1 829 ### ####" },
            { "code": "+1 849 ### ####" },
            { "code": "+1 868 ### ####" },
            { "code": "+1 869 ### ####" },
            { "code": "+1 876 ### ####" },
            { "code": "+216 ## ### ###" },
            { "code": "+218 ## ### ###" },
            { "code": "+222 ## ## ####" },
            { "code": "+223 ## ## ####" },
            { "code": "+224 ## ### ###" },
            { "code": "+225 ## ### ###" },
            { "code": "+226 ## ## ####" },
            { "code": "+227 ## ## ####" },
            { "code": "+228 ## ### ###" },
            { "code": "+229 ## ## ####" },
            { "code": "+231 ## ### ###" },
            { "code": "+234 ## ### ###" },
            { "code": "+236 ## ## ####" },
            { "code": "+241 # ## ## ##" },
            { "code": "+252 ## ### ###" },
            { "code": "+254 ### ######" },
            { "code": "+257 ## ## ####" },
            { "code": "+258 ## ### ###" },
            { "code": "+262 ##### ####" },
            { "code": "+262 ##### ####" },
            { "code": "+266 # ### ####" },
            { "code": "+267 ## ### ###" },
            { "code": "+268 ## ## ####" },
            { "code": "+27 ## ### ####" },
            { "code": "+31 ## ### ####" },
            { "code": "+32 ### ### ###" },
            { "code": "+33 ### ### ###" },
            { "code": "+34 ### ### ###" },
            { "code": "+357 ## ### ###" },
            { "code": "+36 ### ### ###" },
            { "code": "+370 ### ## ###" },
            { "code": "+371 ## ### ###" },
            { "code": "+374 ## ### ###" },
            { "code": "+377 ## ### ###" },
            { "code": "+382 ## ### ###" },
            { "code": "+385 ## ### ###" },
            { "code": "+386 ## ### ###" },
            { "code": "+389 ## ### ###" },
            { "code": "+39 6 698 #####" },
            { "code": "+40 ## ### ####" },
            { "code": "+41 ## ### ####" },
            { "code": "+45 ## ## ## ##" },
            { "code": "+46 ## ### ####" },
            { "code": "+48 ### ### ###" },
            { "code": "+49 ### ## ####" },
            { "code": "+502 # ### ####" },
            { "code": "+503 ## ## ####" },
            { "code": "+509 ## ## ####" },
            { "code": "+51 ### ### ###" },
            { "code": "+56 # #### ####" },
            { "code": "+591 # ### ####" },
            { "code": "+593 # ### ####" },
            { "code": "+594 ##### ####" },
            { "code": "+60 ## ### ####" },
            { "code": "+60 ### ### ###" },
            { "code": "+61 # #### ####" },
            { "code": "+62 ## ### ####" },
            { "code": "+62 8## ### ###" },
            { "code": "+64 ### ### ###" },
            { "code": "+66 ## ### ####" },
            { "code": "+675 ### ## ###" },
            { "code": "+81 ### ### ###" },
            { "code": "+82 ## ### ####" },
            { "code": "+84 ## #### ###" },
            { "code": "+850 ## ### ###" },
            { "code": "+855 ## ### ###" },
            { "code": "+856 ## ### ###" },
            { "code": "+880 ## ### ###" },
            { "code": "+93 ## ### ####" },
            { "code": "+94 ## ### ####" },
            { "code": "+961 ## ### ###" },
            { "code": "+966 # ### ####" },
            { "code": "+967 ## ### ###" },
            { "code": "+968 ## ### ###" },
            { "code": "+971 # ### ####" },
            { "code": "+972 # ### ####" },
            { "code": "+975 17 ### ###" },
            { "code": "+976 ## ## ####" },
            { "code": "+977 ## ### ###" },
            { "code": "+993 # ### ####" },
            { "code": "+20 ### ### ####" },
            { "code": "+211 ## ### ####" },
            { "code": "+212 ## #### ###" },
            { "code": "+213 ## ### ####" },
            { "code": "+218 21 ### ####" },
            { "code": "+221 ## ### ####" },
            { "code": "+233 ### ### ###" },
            { "code": "+235 ## ## ## ##" },
            { "code": "+240 ## ### ####" },
            { "code": "+242 ## ### ####" },
            { "code": "+243 ### ### ###" },
            { "code": "+244 ### ### ###" },
            { "code": "+249 ## ### ####" },
            { "code": "+250 ### ### ###" },
            { "code": "+251 ## ### ####" },
            { "code": "+253 ## ## ## ##" },
            { "code": "+255 ## ### ####" },
            { "code": "+256 ### ### ###" },
            { "code": "+260 ## ### ####" },
            { "code": "+261 ## ## #####" },
            { "code": "+264 ## ### ####" },
            { "code": "+265 # #### ####" },
            { "code": "+30 ### ### ####" },
            { "code": "+351 ## ### ####" },
            { "code": "+352 ### ### ###" },
            { "code": "+353 ### ### ###" },
            { "code": "+355 ### ### ###" },
            { "code": "+359 ### ### ###" },
            { "code": "+377 ### ### ###" },
            { "code": "+378 #### ######" },
            { "code": "+381 ## ### ####" },
            { "code": "+39 ### #### ###" },
            { "code": "+420 ### ### ###" },
            { "code": "+421 ### ### ###" },
            { "code": "+43 ### ### ####" },
            { "code": "+44 ## #### ####" },
            { "code": "+49 ### ### ####" },
            { "code": "+52 ### ### ####" },
            { "code": "+54 ### ### ####" },
            { "code": "+55 ## #### ####" },
            { "code": "+55 ## 7### ####" },
            { "code": "+57 ### ### ####" },
            { "code": "+58 ### ### ####" },
            { "code": "+590 ### ### ###" },
            { "code": "+593 ## ### ####" },
            { "code": "+595 ### ### ###" },
            { "code": "+598 # ### ## ##" },
            { "code": "+62 8## ### ####" },
            { "code": "+63 ### ### ####" },
            { "code": "+64 ### ### ####" },
            { "code": "+7 ### ### ## ##" },
            { "code": "+7 6## ### ## ##" },
            { "code": "+7 7## ### ## ##" },
            { "code": "+81 ## #### ####" },
            { "code": "+84 ### #### ###" },
            { "code": "+86 ### #### ###" },
            { "code": "+886 # #### ####" },
            { "code": "+90 ### ### ####" },
            { "code": "+91 #### ### ###" },
            { "code": "+92 ### ### ####" },
            { "code": "+962 # #### ####" },
            { "code": "+963 ## #### ###" },
            { "code": "+966 5 #### ####" },
            { "code": "+967 ### ### ###" },
            { "code": "+970 ## ### ####" },
            { "code": "+971 5# ### ####" },
            { "code": "+972 5# ### ####" },
            { "code": "+98 ### ### ####" },
            { "code": "+992 ## ### ####" },
            { "code": "+995 ### ### ###" },
            { "code": "+996 ### ### ###" },
            { "code": "+998 ## ### ####" },
            { "code": "+234 ### ### ####" },
            { "code": "+234 ### ### ####" },
            { "code": "+375 ## ### ## ##" },
            { "code": "+380 ## ### ## ##" },
            { "code": "+423 ### ### ####" },
            { "code": "+49 #### ### ####" },
            { "code": "+55 ## 9#### ####" },
            { "code": "+596 ### ## ## ##" },
            { "code": "+850 ### #### ###" },
            { "code": "+850 191 ### ####" },
            { "code": "+856 20## ### ###" },
            { "code": "+86 ### #### ####" },
            { "code": "+964 ### ### ####" },
            { "code": "+994 ## ### ## ##" },
            { "code": "+358 ### ### ## ##" },
            { "code": "+62 8## ### ## ###" },
            { "code": "+86 ## ##### #####" },
            { "code": "+850 #### #############" }
        ];

        maskList.forEach(item => {
            let code = item.code.replace(/[\s#]/g, ''),
                phone = this.value.replace(/[\s#-)(]/g, '');

            if (phone.includes(code)) {
                console.log(phone, code);
                matrix = item.code;
            }
        });

        let i = 0,
            val = this.value.replace(/\D/g, '');

        this.value = matrix.replace(/(?!\+)./g, function(a) {
            return /[#\d]/.test(a) && i < val.length ? val.charAt(i++) : i >= val.length ? '' : a;
        });
    }

    let inputs = document.querySelectorAll(selector);

    inputs.forEach(input => {
        if (!input.value) input.value = '+';
        input.addEventListener('input', setMask);
        input.addEventListener('focus', setMask);
        input.addEventListener('blur', setMask);
    });
};

mask(`[data-type=phone]`);
</script>

<style lang="scss" is:global>
  .mpp-user-data-forms {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    list-style-type: none;
    padding: 0;
  }

  .mpp-user-data-form {
    display: grid;
    gap: 1rem;
    &[data-inputs="3"] {
      @media (min-width: 768px) {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    & input[data-type="phone"] {
        color: transparent;
    }
  }
  .mpp-user-data__head {
    display: block;
    position: relative;
    font-weight: 600;
    &::after {
      content: "";
      position: absolute;
      background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="10" viewBox="0 0 18 10" fill="none"><path d="M1 1L9 9L17 1" stroke="%2342516F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>');
      background-repeat: no-repeat;
      width: 21px;
      height: 11px;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      transition: ease 0.5s;
    }
  }

  .mpp-user-data-wrap {
    display: grid;
    grid-template-rows: 0fr;
    transition-duration: 0.5s;
    transition-property: grid-template-rows, padding;
    width: 100%;
    padding: 0;
  }

  .mpp-user-data-form {
    overflow: hidden;
  }

  .mpp-user-data-item__checkbox[type="checkbox"]:checked ~ .mpp-user-data-wrap {
    grid-template-rows: 1fr;
    padding: 1em 0 0;
  }
  .mpp-user-data-item__checkbox[type="checkbox"]:checked
    ~ .mpp-user-data__head::after {
    transform: translateY(-50%) rotate(180deg);
  }

  .mpp-user-data-item__checkbox[type="checkbox"]:checked ~ .mpp-user-data__head {
    color: var(--primaryColor);
  }

  .mpp-user-data-form-group-buttons {
    & button {
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.875rem;
      outline: none;
      padding: 0.5em 1em;
      transition: ease 0.5s;
      &[data-type="submit"] {
        border: 1px solid var(--primaryColor);
        background-color: var(--primaryColor);
        color: var(--whiteColor);
        &:hover {
          background-color: var(--whiteColor);
          color: var(--primaryColor);
        }
      }
      &[data-type="cancel"] {
        border: 1px solid var(--grayColor);
        background-color: var(--grayColor);
        color: var(--blackColor);
      }
    }

  }

  .mpp-user-data-form-group--has-value input[data-type="phone"] {
    color: inherit;
  }
</style>

<style lang="scss" is:global>
    .message {
        position: relative;
        padding: 0 0 0 1.5em;

        &::before {
            content: "";
            background-repeat: no-repeat;
            background-size: contain;
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
        }
        &--pending::before {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23f3704e" d="M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z" class="spinner_aj0A"/></svg>');
            transform-origin: center;
            animation: spinner .75s infinite linear;        
        }
        &--success::before {
            background-image: url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 9.5L9.5 14.5L16.5 4" stroke="%23F3704E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');  
        }
        &--error::before {
            background-image: url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.2373 5.7627L5.7626 14.2374" stroke="%23F8714C" stroke-linecap="round"/><path d="M14.2373 14.2373L5.7626 5.7626" stroke="%23F8714C" stroke-linecap="round"/></svg>');  
        }
    }

    @keyframes spinner{
            50% {
                transform: translateY(-50%) rotate(180deg);
            }
            100% {
                transform: translateY(-50%) rotate(360deg);
            }
        }
</style>
<style lang="scss" is:global>
    .mpp-form-sertificate {
        font-size: 14px;
        display: grid;
        flex-direction: column;
        gap: 20px 35px;
        background-color: rgba(231, 226, 246, .4);
        max-width: 466px;
        padding: 1.2rem 2.55rem;
        @media (min-width: 768px) {
            grid-template: repeat(2, auto) / repeat(2, 1fr);
        }
    }

    .mpp-form-sertificate-balance {

        & h3 {
            font-size: 1em;
            font-weight: 600;
            margin: 0 0 1.3em;
        }
        & span {
            font-size: 1.71em;
            font-size: 500;
        }
    }

    .mpp-form-sertificate__hint {
        line-height: 1.25;
        @media (min-width: 768px) {
            grid-area: 2 / 1 / 3 / 2;
        }
    }

    .mpp-form-sertificate-code {
        display: flex;
        flex-direction: column;
        gap: .5rem;
    }
</style>

